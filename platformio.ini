; PlatformIO Project Configuration File
; Mouse Trap Monitoring System
;
; Build options: build flags, source filter
; Upload options: custom upload port, speed and extra flags
; Library options: dependencies, extra library storages
; Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = trap-node

; ==================== TRAP NODE CONFIGURATION ====================
[env:trap-node]
platform = espressif32
board = esp32-c3-devkitm-1
framework = arduino

; Serial Monitor Configuration
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder
    time

; Upload Configuration
upload_speed = 921600
upload_port = /dev/ttyUSB0  ; Change to your port (COM3 on Windows)

; Build Flags
build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DBOARD_HAS_PSRAM=0
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; Uncomment and modify gateway MAC address
    ; -DGATEWAY_MAC="{0x24,0x0A,0xC4,0x12,0x34,0x56}"
    
; Library Dependencies
lib_deps = 
    bblanchon/ArduinoJson@^6.21.3

; Partition Scheme
board_build.partitions = default.csv

; ==================== GATEWAY CONFIGURATION ====================
[env:gateway]
platform = espressif32
board = esp32dev  ; or esp32-c3-devkitm-1 for ESP32-C3
framework = arduino

; Serial Monitor Configuration
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder
    time

; Upload Configuration
upload_speed = 921600
upload_port = /dev/ttyUSB0  ; Change to your port

; Build Flags
build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DBOARD_HAS_PSRAM=0

; Library Dependencies
lib_deps = 
    bblanchon/ArduinoJson@^6.21.3
    knolleary/PubSubClient@^2.8

; ==================== XIAO ESP32-C3 SPECIFIC ====================
[env:xiao-esp32c3]
platform = espressif32
board = seeed_xiao_esp32c3
framework = arduino

monitor_speed = 115200
upload_speed = 921600

build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DNODE_ID=1  ; Change for each trap

lib_deps = 
    bblanchon/ArduinoJson@^6.21.3

; ==================== DEBUG CONFIGURATION ====================
[env:trap-node-debug]
extends = env:trap-node
build_type = debug
build_flags = 
    ${env:trap-node.build_flags}
    -DCORE_DEBUG_LEVEL=5
    -DDEBUG_ESP_PORT=Serial
    -DDEBUG_ESP_CORE

; ==================== OTA UPDATE CONFIGURATION ====================
[env:trap-node-ota]
extends = env:trap-node
upload_protocol = espota
upload_port = trap-node-1.local  ; Change to your node's hostname
upload_flags = 
    --auth=your-ota-password

; ==================== COMMON SETTINGS ====================
[env]
; Additional scripts
extra_scripts = 
    ; post:scripts/post_build.py  ; Uncomment if you have custom scripts

; Code quality checks
check_tool = cppcheck, clangtidy
check_flags = 
    cppcheck: --enable=all
    clangtidy: --checks=-*,cert-*,clang-analyzer-*

; Test Configuration
test_framework = unity
test_build_src = yes

; ==================== BOARD VARIANTS ====================

; For generic ESP32
[env:esp32-generic]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
lib_deps = 
    bblanchon/ArduinoJson@^6.21.3
    knolleary/PubSubClient@^2.8

; For ESP32-S3
[env:esp32s3]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
build_flags = 
    -DARDUINO_USB_CDC_ON_BOOT=1
lib_deps = 
    bblanchon/ArduinoJson@^6.21.3

; ==================== NOTES ====================
; 
; QUICK START:
; 1. Install PlatformIO: https://platformio.org/install
; 2. For trap node: pio run -e trap-node -t upload
; 3. For gateway: pio run -e gateway -t upload
; 4. Monitor serial: pio device monitor
;
; MULTIPLE NODES:
; Flash each node with unique NODE_ID in firmware
; Or use build flags: -DNODE_ID=2
;
; BOARD SELECTION:
; - Seeed XIAO ESP32-C3: use env:xiao-esp32c3
; - Generic ESP32: use env:esp32-generic  
; - ESP32-S3: use env:esp32s3
;
; TROUBLESHOOTING:
; - If upload fails, hold BOOT button while uploading
; - Check USB cable (must be data cable, not charging only)
; - Verify correct port: pio device list
; - Try slower upload speed: upload_speed = 115200
;
